<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DeFire On-Chain Net Worth (WinkLink)</title>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@5.3.0/dist/TronWeb.min.js"></script>
  <style>
    :root{--bg:#0b0b0f;--card:#141416;--accent:#ff6a00;--ok:#00ffc3;--warn:#ffd166;--err:#ff6b6b}
    body{font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(135deg,#0b0b0f,#1a0a00);color:#fff;margin:0;padding:20px;display:flex;justify-content:center}
    .wrap{width:100%;max-width:980px}
    h1{margin:0;font-size:1.9rem;text-align:center}
    .card{background:rgba(0,0,0,0.5);border-radius:12px;padding:16px;margin-top:16px;box-shadow:0 6px 30px rgba(0,0,0,0.6)}
    .row{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
    label{min-width:120px;opacity:.9}
    input[type=text]{flex:1;padding:10px;border-radius:8px;border:none;background:#0f1113;color:#fff}
    button{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-family:ui-monospace,monospace}
    .muted{opacity:.8;font-size:.9rem}
    .total{font-size:1.35rem;font-weight:800;text-align:center;margin-top:12px}
    .small{font-size:.9rem;opacity:.85}
    .list{margin-top:8px}
    .addr{font-family:ui-monospace,monospace;color:#9fd8ff}
    .warn{color:var(--warn)}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,0.15);border-top:3px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    footer{margin-top:14px;color:#cfcfcf;text-align:center;font-size:.9rem}
    .skipped{margin-top:8px;color:#ffd8d8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>🔥 DeFire On-Chain Net Worth (WinkLink)</h1>

    <div class="card" id="walletCard">
      <h2 style="margin:0 0 8px">Wallet Access</h2>
      <div class="row"><label>Connected Wallet</label><div class="pill addr" id="connected">Not connected</div></div>
      <div class="row"><label>FBA Balance</label><div class="pill" id="fba">—</div></div>
      <div class="row"><label>Access Status</label><div class="pill" id="status">Connect TronLink to begin</div></div>
      <div class="row">
        <button id="btnConnect">🔗 Connect TronLink</button>
        <div class="muted" style="margin-left:auto">Whitelist: owner OR ≥1000 FBA unlocks Portfolio</div>
      </div>
    </div>

    <div class="card" id="portfolioCard" style="display:none">
      <h2 style="margin:0 0 8px">Portfolio — add wallets</h2>
      <div class="row">
        <input id="walletInput" type="text" placeholder="Enter TRON address (T...); paste comma-separated for many" />
        <button id="btnAdd">+ Add</button>
      </div>
      <div class="list" id="list"></div>

      <div class="row" style="margin-top:12px">
        <button id="btnCalc">🧮 Calculate Net Worth (USD)</button>
        <div class="pill" id="progress">Idle</div>
      </div>

      <div class="total" id="grand">Grand Total: —</div>
      <div class="skipped" id="skipped"></div>
      <div class="small muted" style="margin-top:8px">Note: tokens without a WinkLink oracle are excluded from total and listed above.</div>
    </div>

    <footer>All reads are client-side. No keys uploaded. Open in TronLink (mobile) or desktop TronLink extension.</footer>
  </div>

<script>
/* ================== CONFIG ==================
   - OWNER_WALLET: owner bypass
   - FBA_CONTRACT: Football Alien token contract (TRC20)
   - FBA_MIN: how many FBA required to unlock
   - ORACLE_BY_SYMBOL: common mapping symbol -> WinkLink oracle address
   - ORACLE_BY_CONTRACT: optional map where you supply TRC20 contract -> oracle address
   - TRONSCan endpoints used for token lists (no API key required for moderate usage)
   ============================================ */

const OWNER_WALLET = "TY691Xr2EWgKJmHfm7NWKMRJjojLmS2cma";
const FBA_CONTRACT = "TNW5ABkp3v4jfeDo1vRVjxa3gtnoxP3DBN";
const FBA_MIN = 1000; // tokens

// WinkLink feeds (mainnet) — common symbols
const ORACLE_BY_SYMBOL = {
  TRX: "TR5HtpPK4gX4RFC4DCBUHfFgsGkGFEzSAb", // TRX/USD
  USDT: "TKePc46n5CiUCR8LL788TFeKA4kjvNnuem", // USDT/USD
  USDC: "TNu3zS55MP4KnBBP6aw1nHSzRpc3CXAxm", // USDC/USD
  SUN: "TRMgzSPsuWEcVpd5hv19XtLeCk8Z799sZa",  // SUN/USD
  JST: "TE5rKoDzKmpVAQp1sn7x6V8biivR3d5r47",  // JST/USD
  BTT: "TBAAW545oJ6iTxqzezVagrSUzCpz1S8eR",  // BTT/USD
  WIN: "TSCef3LT3jpLwwXCWhZe3hZoMsYk1ZLif2",  // WIN/USD
  BTC: "TQoijQ1iZKRgJsAAWNPMu6amgtCJ3WMUV7",  // BTC/USD
  ETH: "TR2yWYWovJaSM7TfZq7L7sT7ZRugdJJQmL"   // ETH/USD
};

// Optional explicit contract -> oracle mapping (paste token contract => oracle if needed)
const ORACLE_BY_CONTRACT = {
  // "TXXXXXXXX...": "TOracleAddress..."
};

// Tronscan API endpoints
const TSCAN_TOKENS   = addr => `https://apilist.tronscanapi.com/api/account/tokens?address=${addr}&limit=200`;
const TSCAN_ACCOUNT  = addr => `https://apilist.tronscanapi.com/api/account?address=${addr}`;

/* ============ DOM ============ */
const elConnected = document.getElementById("connected");
const elFba = document.getElementById("fba");
const elStatus = document.getElementById("status");
const elPortfolioCard = document.getElementById("portfolioCard");
const elWalletInput = document.getElementById("walletInput");
const elList = document.getElementById("list");
const elBtnConnect = document.getElementById("btnConnect");
const elBtnAdd = document.getElementById("btnAdd");
const elBtnCalc = document.getElementById("btnCalc");
const elProgress = document.getElementById("progress");
const elGrand = document.getElementById("grand");
const elSkipped = document.getElementById("skipped");

/* ============ STATE ============ */
let tronWebInstance = null;
let connectedAddr = "";
let watchList = []; // wallets to include (connected wallet will be added automatically when whitelisted)

/* ============ HELPERS ============ */
const fmtUSD = n => Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});
const sleep = ms => new Promise(r => setTimeout(r, ms));
const uniqPush = (arr, v) => { if(!arr.includes(v)) arr.push(v); };

function sanitizeAddr(s){ return (s||"").trim(); }

// Convert BigInt raw + decimals to JS Number (safe-ish for UI)
// show up to 8 decimals for small values
function toNumberFromRaw(rawBigInt, decimals){
  try{
    const scale = 10n ** BigInt(decimals);
    const intPart = rawBigInt / scale;
    const frac = rawBigInt % scale;
    let fracStr = frac.toString().padStart(decimals,"0");
    // limit fractional digits for display and conversion
    fracStr = fracStr.slice(0, 8).replace(/0+$/,"");
    const s = fracStr ? `${intPart.toString()}.${fracStr}` : `${intPart.toString()}`;
    return Number(s);
  }catch(e){ return 0; }
}

/* ============ WINKLINK ORACLE READ ============ */
// Reads latestAnswer() and decimals() from a WinkLink oracle contract address
async function readOraclePriceUSD(oracleAddr){
  try{
    const c = await tronWebInstance.contract().at(oracleAddr);
    // read decimals if available
    let od = 8;
    try{
      const d = await c.decimals().call();
      od = Number(d?.toString?.() ?? d ?? 8);
      if (!Number.isFinite(od)) od = 8;
    }catch(_){ od = 8; }
    const ans = await c.latestAnswer().call();
    const raw = BigInt(ans?.toString?.() ?? ans ?? "0");
    if (raw <= 0n) return null;
    // convert to JS number scaled to actual USD value
    return Number(raw) / Math.pow(10, od);
  }catch(e){
    console.warn("Oracle read failed", oracleAddr, e);
    return null;
  }
}

/* ============ BALANCE FETCHERS ============ */
async function fetchTRXBalance(addr){
  try{
    // tronWeb.trx.getBalance returns SUN (integer) — might be number or string
    const sun = await tronWebInstance.trx.getBalance(addr);
    const sunBN = BigInt(typeof sun === "number" ? Math.trunc(sun) : String(sun));
    return toNumberFromRaw(sunBN, 6); // TRX has 6 decimals (sun)
  }catch(e){
    console.error("TRX balance error", addr, e);
    return 0;
  }
}

async function fetchTRC20List(addr){
  // Use Tronscan tokens endpoint — returns token list and balances
  try{
    const res = await fetch(TSCAN_TOKENS(addr));
    if(!res.ok) throw new Error("Tronscan HTTP " + res.status);
    const json = await res.json();
    const list = json?.data || json?.tokens || [];
    // Normalize each token into {symbol, name, contract, tokenDecimal, balanceRaw (BigInt)}
    return list.map(t => {
      // tronscan returns different shapes in different calls; handle a few forms
      const contract = t.tokenId || t.tokenAddress || t.contract_address || t.contract || "";
      const decimals = Number(t.tokenDecimal ?? t.decimals ?? t.decimalsToken ?? 6);
      const rawStr = String(t.balance ?? t.amount ?? t.quantity ?? t.rawBalance ?? "0");
      // Some endpoints return already divided number; prefer raw if available (they usually have raw)
      return {
        symbol: t.tokenAbbr || t.symbol || t.tokenName || "UNKNOWN",
        name: t.tokenName || t.name || "",
        contract,
        decimals,
        balanceRaw: BigInt(rawStr)
      };
    });
  }catch(e){
    console.error("TRC20 list fetch failed for", addr, e);
    return [];
  }
}

/* ============ ORACLE LOOKUP ============ */
async function getOracleForToken(symbol, contract){
  // First try explicit contract map
  if (contract && ORACLE_BY_CONTRACT[contract]) return ORACLE_BY_CONTRACT[contract];
  // Then try symbol mapping (uppercased)
  const s = (symbol||"").toString().toUpperCase();
  if (ORACLE_BY_SYMBOL[s]) return ORACLE_BY_SYMBOL[s];
  return null;
}

/* ============ ACCESS CONTROL: FBA check ============ */
async function checkWhitelist(addr){
  try{
    if (addr === OWNER_WALLET){
      elFba.textContent = "Owner";
      elStatus.innerHTML = '<span class="ok">✅ Owner connected — access granted.</span>';
      return true;
    }
    // read FBA balance via contract
    const c = await tronWebInstance.contract().at(FBA_CONTRACT);
    const raw = await c.balanceOf(addr).call();
    // get decimals (if available)
    let dec = 6;
    try{ const d = await c.decimals().call(); dec = Number(d?.toString?.() ?? d ?? 6); }catch(_){ dec = 6; }
    const bal = toNumberFromRaw(BigInt(raw?.toString?.() ?? raw ?? "0"), dec);
    elFba.textContent = `${bal.toLocaleString(undefined,{maximumFractionDigits:6})} FBA`;
    if (bal >= FBA_MIN){
      elStatus.innerHTML = '<span class="ok">✅ Whitelisted — enough FBA.</span>';
      return true;
    } else {
      elStatus.innerHTML = `<span class="err">⛔ Need ≥ ${FBA_MIN} FBA to unlock.</span>`;
      return false;
    }
  }catch(e){
    console.error("FBA check failed", e);
    elFba.textContent = "Error";
    elStatus.innerHTML = '<span class="err">⚠️ Error checking FBA balance.</span>';
    return false;
  }
}

/* ============ APP FLOW ============ */
async function connectWallet(){
  if (!window.tronWeb){
    elStatus.innerHTML = '<span class="warn">🔸 TronLink not detected. Open in TronLink browser and unlock.</span>';
    return;
  }
  // Wait for tronWeb injection and readiness
  tronWebInstance = window.tronWeb;
  connectedAddr = tronWebInstance.defaultAddress?.base58 || "";
  elConnected.textContent = connectedAddr || "Unknown";
  if(!connectedAddr){
    elStatus.innerHTML = '<span class="warn">Unlock TronLink to continue.</span>';
    return;
  }

  elStatus.innerHTML = '<span class="muted">Checking whitelist… <span class="spinner"></span></span>';
  const allowed = await checkWhitelist(connectedAddr);
  if (allowed){
    elPortfolioCard.style.display = "block";
    uniqPush(watchList, connectedAddr); // add connected wallet by default
    renderWatchList();
  } else {
    elPortfolioCard.style.display = "none";
  }
}

function renderWatchList(){
  elList.innerHTML = "";
  watchList.forEach((a,i) => {
    const row = document.createElement("div");
    row.className = "row";
    const left = document.createElement("div");
    left.className = "addr";
    left.textContent = a;
    const rm = document.createElement("button");
    rm.textContent = "Remove";
    rm.onclick = () => { watchList.splice(i,1); renderWatchList(); };
    row.appendChild(left);
    row.appendChild(rm);
    elList.appendChild(row);
  });
}

/* ============ CORE: calculate net worth across watchList ============ */
async function calculateNetWorth(){
  if(!tronWebInstance) { alert("Connect TronLink first"); return; }
  if(watchList.length === 0) { alert("Add at least one wallet"); return; }

  elProgress.textContent = "Calculating…";
  elGrand.textContent = "Grand Total: calculating…";
  elSkipped.textContent = "";

  // Get TRX price from WinkLink (oracle symbol TRX)
  const trxOracle = ORACLE_BY_SYMBOL.TRX;
  const trxPrice = trxOracle ? await readOraclePriceUSD(trxOracle) : null;
  if(trxPrice == null){ elProgress.textContent = "Failed to read TRX oracle"; return; }

  let grandTotalUSD = 0;
  const skippedTokensSet = new Set();

  for (const addr of watchList){
    elProgress.textContent = `Processing ${addr} …`;

    // 1) native TRX
    const trxBal = await fetchTRXBalance(addr); // in TRX float
    const trxUsdVal = trxBal * trxPrice;
    grandTotalUSD += trxUsdVal;

    // 2) TRC20 tokens (list from Tronscan)
    const tokens = await fetchTRC20List(addr);
    // tokens array: {symbol, name, contract, decimals, balanceRaw (BigInt)}
    for (const t of tokens){
      // skip if no contract address
      if(!t.contract) continue;
      // Try get oracle for the token
      const oracleAddr = await getOracleForToken(t.symbol, t.contract);
      if(!oracleAddr){
        // no oracle — skip but record
        skippedTokensSet.add(`${t.symbol} (${t.contract.slice(0,6)}…${t.contract.slice(-4)})`);
        continue;
      }

      // Read oracle price
      const price = await readOraclePriceUSD(oracleAddr);
      if(price == null){
        skippedTokensSet.add(`${t.symbol} (${t.contract.slice(0,6)}…${t.contract.slice(-4)})`);
        continue;
      }

      // token raw -> units (Number)
      const units = toNumberFromRaw(t.balanceRaw, t.decimals);
      if(units <= 0) continue;

      // add value
      grandTotalUSD += units * price;

      // small pause to avoid hitting nodes too hard
      await sleep(60);
    }
  }

  elGrand.textContent = `Grand Total: ${fmtUSD(grandTotalUSD)}`;
  elProgress.textContent = "Done";
  if(skippedTokensSet.size > 0){
    elSkipped.textContent = "Skipped tokens (no WinkLink feed): " + Array.from(skippedTokensSet).slice(0,40).join(", ");
  } else {
    elSkipped.textContent = "";
  }
}

/* ============ EVENTS ============ */
elBtnConnect.onclick = () => connectWallet();

elBtnAdd.onclick = () => {
  const raw = sanitizeAddr(elWalletInput.value);
  if(!raw) return;
  // allow comma-separated list
  const parts = raw.split(",").map(s=>s.trim()).filter(Boolean);
  for(const p of parts){
    if(!p.startsWith("T")){ alert("Invalid TRON address: " + p); continue; }
    uniqPush(watchList, p);
  }
  elWalletInput.value = "";
  renderWatchList();
};

elBtnCalc.onclick = () => calculateNetWorth();

/* auto attempt connect on load if TronLink injected */
window.addEventListener("load", () => setTimeout(() => {
  if(window.tronWeb && window.tronWeb.ready) connectWallet();
}, 500));

</script>
</body>
</html>
