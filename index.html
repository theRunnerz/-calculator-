<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>üî• DeFire Net Worth (TRON + WinkLink) üî•</title>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@5.3.0/dist/TronWeb.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: linear-gradient(135deg,#0d0d0f,#ff6a00); color:#fff; margin:0; padding:24px 16px 64px; text-align:center; }
    h1{ font-size:2.2rem; margin:0 0 6px; }
    h2{ margin:12px 0 6px; font-weight:600;}
    .card{ background: rgba(0,0,0,.7); border-radius:16px; max-width:840px; margin:16px auto; padding:18px; box-shadow:0 0 18px rgba(255,120,0,.5); text-align:left; }
    .row{ display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap:wrap;}
    label{ min-width:160px; opacity:.92;}
    input{ flex:1; min-width:240px; padding:10px 12px; border-radius:10px; border:none; background:#141418; color:#fff; font-size:1rem; }
    button{ border:none; border-radius:10px; padding:10px 14px; background:#ff6a00; color:#fff; font-weight:700; cursor:pointer; transition:.2s; }
    button:hover{ background:#ff7f2a; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(0,0,0,.45); font-size:.92rem; margin:4px 6px 0; }
    .ok{ color:#00ffc3; } .warn{ color:#ffd166; } .err{ color:#ff6b6b; }
    .muted{ opacity:.8; font-size:.92rem;}
    .list{ margin-top:6px; }
    .addr{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.95rem;}
    .total{ font-size:1.5rem; font-weight:800; text-align:center; margin-top:8px;}
    .note{ font-size:.9rem; opacity:.85; margin-top:6px;}
    .grid{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center;}
    .divider{ height:1px; background:rgba(255,255,255,.12); margin:12px 0; }
  </style>
</head>
<body>
  <h1>üî• DeFire Net Worth üî•</h1>
  <h3>Built on TRON ‚Ä¢ On-chain prices via WinkLink</h3>

  <!-- Wallet / Access -->
  <div class="card">
    <h2>Wallet Access</h2>
    <div class="row">
      <label>Connected Wallet</label>
      <div class="pill" id="addr">Not connected</div>
    </div>
    <div class="row">
      <label>FBA Balance</label>
      <div class="pill" id="fba">‚Äî</div>
    </div>
    <div class="row">
      <label>Access Status</label>
      <div class="pill" id="status">Connect wallet to begin</div>
    </div>
    <div class="row">
      <button id="btnConnect">üîó Connect TronLink</button>
    </div>
    <div class="note">Whitelist rule: connected wallet must be owner or hold ‚â• <b>1000 FBA</b>. Other wallets you add below don‚Äôt need FBA.</div>
  </div>

  <!-- Portfolio (only shows when whitelisted) -->
  <div class="card" id="portfolio" style="display:none;">
    <h2>Portfolio (Grand Total in USD)</h2>

    <div class="grid">
      <input id="inputAddr" placeholder="Enter a TRON address (starts with T‚Ä¶)" />
      <button id="btnAdd">+ Add Wallet</button>
    </div>
    <div class="list" id="list"></div>
    <div class="divider"></div>

    <div class="row">
      <button id="btnCalc">üßÆ Calculate Net Worth</button>
      <div class="pill muted" id="progress">Idle</div>
    </div>

    <div class="total" id="grand">Grand Total: ‚Äî</div>
    <div class="note" id="skipped"> </div>
  </div>

  <script>
    // ====== CONFIG ======
    const OWNER_WALLET = "TY691Xr2EWgKJmHfm7NWKMRJjojLmS2cma";
    const FBA_CONTRACT = "TNW5ABkp3v4jfeDo1vRVjxa3gtnoxP3DBN"; // Football Alien TRC20
    const FBA_MIN = 1000;

    // WinkLink oracle feeds (TRON mainnet). Decimals typically 6‚Äì8; we detect at runtime.
    // Map by SYMBOL and by CONTRACT for robustness.
    const ORACLE_BY_SYMBOL = {
      TRX: "TR5HtpPK4gX4RFC4DCBUHfFgsGkGFEzSAb", // TRX / USD
      USDT: "TKePc46n5CiUCR8LL788TFeKA4kjvNnuem", // USDT / USD
      WIN: "TSCef3LT3jpLwwXCWhZe3hZoMsYk1ZLif2",  // WIN / USD
      SUN: "TRMgzSPsuWEcVpd5hv19XtLeCk8Z799sZa",  // SUN / USD
      JST: "TE5rKoDzKmpVAQp1sn7x6V8biivR3d5r47",  // JST / USD
      BTT: "TBAAW545oJ6iTxqzezVagrSUzCpz1S8eR",  // BTT / USD
      ETH: "TR2yWYWovJaSM7TfZq7L7sT7ZRugdJJQmL",  // ETH / USD
      BTC: "TQoijQ1iZKRgJsAAWNPMu6amgtCJ3WMUV7"   // BTC / USD
    };

    // Optional: map by TRC20 contract address (base58) ‚Üí oracle. Add as you need.
    const ORACLE_BY_CONTRACT = {
      // example: "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj": ORACLE_BY_SYMBOL.USDT
    };

    // Tronscan API (public). You can add TRON-PRO-API-KEY header if you have one.
    const TSCAN = {
      account: addr => `https://apilist.tronscanapi.com/api/account?address=${addr}`,
      tokens:  addr => `https://apilist.tronscanapi.com/api/account/tokens?address=${addr}&limit=200`
    };

    // ====== DOM ======
    const elAddr = document.getElementById("addr");
    const elFba  = document.getElementById("fba");
    const elStatus = document.getElementById("status");
    const elPortfolio = document.getElementById("portfolio");
    const elInput = document.getElementById("inputAddr");
    const elList = document.getElementById("list");
    const elGrand = document.getElementById("grand");
    const elProgress = document.getElementById("progress");
    const elSkipped = document.getElementById("skipped");
    const btnConnect = document.getElementById("btnConnect");
    const btnAdd = document.getElementById("btnAdd");
    const btnCalc = document.getElementById("btnCalc");

    // ====== STATE ======
    let connected = "";
    let watchList = []; // addresses to include (connected wallet auto-added once whitelisted)

    // ====== UTILS ======
    const fmtUSD = n => Number(n).toLocaleString(undefined,{ style:"currency", currency:"USD", maximumFractionDigits:2 });
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    function uniqPush(arr, v){ if(!arr.includes(v)) arr.push(v); }
    function sanitizeAddr(s){ return (s||"").trim(); }

    async function getOraclePriceUSD(oracleAddr){
      try{
        const c = await tronWeb.contract().at(oracleAddr);
        let decimals = 8;
        try{
          const d = await c.decimals().call();
          decimals = Number(d?.toString?.() ?? d ?? 8);
          if (!Number.isFinite(decimals)) decimals = 8;
        }catch(_){}
        const ans = await c.latestAnswer().call();
        const raw = BigInt(ans?.toString?.() ?? ans ?? "0");
        // scale to JS number
        return Number(raw.toString()) / (10 ** decimals);
      }catch(e){
        console.error("Oracle read failed:", oracleAddr, e);
        return null;
      }
    }

    async function getTRXPriceUSD(){
      const o = ORACLE_BY_SYMBOL.TRX;
      if(!o) return null;
      return getOraclePriceUSD(o);
    }

    async function fetchTRXBalanceSun(addr){
      try{
        const sun = await tronWeb.trx.getBalance(addr);
        return typeof sun === "number" ? sun : Number(sun);
      }catch(e){ console.error("TRX bal error", addr, e); return 0; }
    }

    async function fetchTRC20Balances(addr){
      try{
        const res = await fetch(TSCAN.tokens(addr));
        const data = await res.json();
        // Normalize: [{symbol, name, contract, balanceRaw, decimals}]
        const list = (data?.data || []).map(t => ({
          symbol: t.tokenAbbr || t.symbol || t.tokenName || "UNKNOWN",
          name: t.tokenName || t.name || t.tokenAbbr || "Unknown",
          contract: t.tokenId || t.contract_address || "",
          decimals: Number(t.tokenDecimal ?? t.decimals ?? 6),
          balanceRaw: BigInt(String(t.balance ?? "0"))
        }));
        return list;
      }catch(e){
        console.error("TRC20 fetch error", addr, e);
        return [];
      }
    }

    function toUnits(rawBigInt, decimals){
      const scale = 10n ** BigInt(decimals);
      const intPart = rawBigInt / scale;
      const frac = rawBigInt % scale;
      const fracStr = frac.toString().padStart(decimals,"0").replace(/0+$/,"");
      const s = fracStr ? `${intPart}.${fracStr.slice(0, 8)}` : `${intPart}`;
      return Number(s);
    }

    async function getTokenPriceUSD(symbol, contract){
      // Contract-specific oracle first, then symbol fallback
      const byContract = ORACLE_BY_CONTRACT[contract];
      if (byContract){
        const p = await getOraclePriceUSD(byContract);
        if (p != null) return p;
      }
      const o = ORACLE_BY_SYMBOL[symbol?.toUpperCase?.() || ""];
      if (!o) return null;
      return getOraclePriceUSD(o);
    }

    // ====== ACCESS CONTROL (FBA or owner) ======
    async function checkAccess(addr){
      if (addr === OWNER_WALLET){
        elStatus.innerHTML = '<span class="ok">‚úÖ Owner connected ‚Äî access granted.</span>';
        return true;
      }
      // Read FBA balance from contract
      try{
        const c = await tronWeb.contract().at(FBA_CONTRACT);
        const balRaw = await c.balanceOf(addr).call();
        // Try decimals (default 6)
        let dec = 6;
        try{
          const d = await c.decimals().call();
          dec = Number(d?.toString?.() ?? d ?? 6);
          if (!Number.isFinite(dec)) dec = 6;
        }catch(_){}
        const bi = BigInt(balRaw?.toString?.() ?? balRaw ?? "0");
        const units = toUnits(bi, dec);
        elFba.textContent = `${units.toLocaleString(undefined,{maximumFractionDigits:6})} FBA`;
        if (units >= FBA_MIN){
          elStatus.innerHTML = '<span class="ok">‚úÖ Whitelisted ‚Äî ‚â• 1000 FBA detected.</span>';
          return true;
        }else{
          elStatus.innerHTML = `<span class="err">‚õî Need at least ${FBA_MIN} FBA to unlock.</span>`;
          return false;
        }
      }catch(e){
        console.error("FBA check failed", e);
        elFba.textContent = "Error";
        elStatus.innerHTML = '<span class="err">‚ö†Ô∏è Error checking FBA balance.</span>';
        return false;
      }
    }

    // ====== APP FLOW ======
    async function connect(){
      if (!window.tronWeb || !window.tronWeb.ready){
        elStatus.innerHTML = '<span class="warn">üî∏ TronLink not detected. Open in TronLink in-app browser and unlock.</span>';
        return;
      }
      connected = tronWeb.defaultAddress?.base58 || "";
      elAddr.textContent = connected || "Unknown";
      if (!connected){
        elStatus.innerHTML = '<span class="warn">Unlock TronLink to continue.</span>';
        return;
      }
      const allowed = await checkAccess(connected);
      if (allowed){
        elPortfolio.style.display = "block";
        // include connected wallet by default (only once)
        uniqPush(watchList, connected);
        renderList();
      }else{
        elPortfolio.style.display = "none";
      }
    }

    function renderList(){
      elList.innerHTML = "";
      watchList.forEach((a, i) => {
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `<div class="addr" style="flex:1">${a}</div>`;
        const rm = document.createElement("button");
        rm.textContent = "Remove";
        rm.onclick = () => { watchList.splice(i,1); renderList(); };
        row.appendChild(rm);
        elList.appendChild(row);
      });
    }

    async function calcNetWorthUSD(){
      if (watchList.length === 0){
        elGrand.textContent = "Grand Total: ‚Äî";
        elSkipped.textContent = "";
        return;
      }
      elProgress.textContent = "Fetching prices‚Ä¶";
      const trxPrice = await getTRXPriceUSD();
      if (trxPrice == null){
        elProgress.textContent = "Failed to read TRX/USD oracle.";
        return;
      }

      let totalUSD = 0;
      let skipped = [];
      elProgress.textContent = "Querying balances‚Ä¶";

      for (const addr of watchList){
        // TRX
        const sun = await fetchTRXBalanceSun(addr);
        const trx = sun / 1e6;
        totalUSD += trx * trxPrice;

        // TRC20
        const tokens = await fetchTRC20Balances(addr);
        for (const t of tokens){
          // Skip FBA decimals 6 default if missing handled in parser
          const balUnits = toUnits(t.balanceRaw, t.decimals);
          if (balUnits <= 0) continue;

          const price = await getTokenPriceUSD(t.symbol, t.contract);
          if (price == null){
            skipped.push(`${t.symbol} (${t.contract.slice(0,6)}‚Ä¶${t.contract.slice(-4)})`);
            continue;
          }
          totalUSD += balUnits * price;

          // small delay to avoid spamming nodes
          await sleep(80);
        }
      }

      elGrand.textContent = `Grand Total: ${fmtUSD(totalUSD)}`;
      elProgress.textContent = "Done";
      elSkipped.textContent = skipped.length ? `No WinkLink price feed for: ${skipped.join(", ")}` : "";
    }

    // ====== EVENTS ======
    btnConnect.onclick = connect;
    btnAdd.onclick = () => {
      const a = sanitizeAddr(elInput.value);
      if (!a || !a.startsWith("T")) { alert("Enter a valid TRON address (starts with T‚Ä¶)"); return; }
      uniqPush(watchList, a);
      elInput.value = "";
      renderList();
    };
    btnCalc.onclick = calcNetWorthUSD;

    // Auto-connect attempt after load (doesn't prompt; TronLink must be unlocked)
    window.addEventListener("load", () => setTimeout(connect, 400));
  </script>
</body>
</html>
